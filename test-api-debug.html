<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS API Debug Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc00;
        }
        #log {
            background: #000;
            padding: 20px;
            border: 1px solid #00ff00;
            min-height: 400px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .info { color: #ffff00; }
        .step { color: #00ffff; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üîç TTS API Debug Test</h1>
    <p>This will test each step of the synthesis pipeline and show exactly what's happening.</p>

    <button onclick="testAPI()">Test Google Cloud TTS API</button>
    <button onclick="testSimpleAudio()">Test Simple Audio Playback</button>
    <button onclick="clearLog()">Clear Log</button>

    <div id="log"></div>

    <script type="module">
        import { TTS_API_KEY } from './src/config.js';

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const className = type;
            logDiv.innerHTML += `<span class="${className}">${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        window.testSimpleAudio = async function() {
            log('\n========================================', 'step');
            log('üîä TESTING BASIC AUDIO PLAYBACK', 'step');
            log('========================================\n', 'step');

            try {
                // Test if browser can play audio at all
                log('Step 1: Creating test audio element...', 'info');
                const audio = new Audio();

                log('Step 2: Testing with a sine wave beep...', 'info');

                // Create a simple beep using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 440; // A4 note
                gainNode.gain.value = 0.3;

                log('Step 3: Playing 500ms beep...', 'info');
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    log('‚úì Audio playback works!', 'success');
                }, 500);

            } catch (error) {
                log(`‚úó Audio playback failed: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        window.testAPI = async function() {
            log('\n========================================', 'step');
            log('üé§ TESTING GOOGLE CLOUD TTS API', 'step');
            log('========================================\n', 'step');

            try {
                // Step 1: Check API key
                log('Step 1: Checking API key...', 'info');
                log(`API Key: ${TTS_API_KEY ? TTS_API_KEY.substring(0, 20) + '...' : 'NOT FOUND'}`, TTS_API_KEY ? 'success' : 'error');

                if (!TTS_API_KEY) {
                    log('‚úó No API key found in src/config.js', 'error');
                    return;
                }

                // Step 2: Build simple SSML
                log('\nStep 2: Building test SSML...', 'info');
                const ssml = '<speak>Viking. Southwesterly 7. Rough. Rain. Good.</speak>';
                log(`SSML: ${ssml}`, 'success');

                // Step 3: Make API request
                log('\nStep 3: Calling Google Cloud TTS API...', 'info');
                const endpoint = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${TTS_API_KEY}`;

                const requestBody = {
                    input: { ssml: ssml },
                    voice: {
                        languageCode: 'en-GB',
                        name: 'en-GB-Neural2-B'
                    },
                    audioConfig: {
                        audioEncoding: 'MP3',
                        sampleRateHertz: 24000
                    }
                };

                log('Sending request...', 'info');
                const startTime = Date.now();

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const elapsed = Date.now() - startTime;
                log(`Response received in ${elapsed}ms`, 'success');
                log(`HTTP Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    const errorData = await response.json();
                    log(`‚úó API Error: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    return;
                }

                // Step 4: Parse response
                log('\nStep 4: Parsing response...', 'info');
                const data = await response.json();

                if (data.audioContent) {
                    const audioSize = data.audioContent.length;
                    log(`‚úì Received audio data: ${audioSize} bytes (base64)`, 'success');
                    log(`Estimated MP3 size: ~${Math.round(audioSize * 0.75 / 1024)}KB`, 'info');
                } else {
                    log('‚úó No audio content in response', 'error');
                    log(`Response: ${JSON.stringify(data)}`, 'error');
                    return;
                }

                // Step 5: Convert to blob
                log('\nStep 5: Converting to audio blob...', 'info');
                const binaryString = atob(data.audioContent);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const audioBlob = new Blob([bytes], { type: 'audio/mpeg' });
                log(`‚úì Created blob: ${audioBlob.size} bytes`, 'success');

                // Step 6: Play audio
                log('\nStep 6: Playing audio...', 'info');
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                audio.onloadedmetadata = () => {
                    log(`‚úì Audio loaded: ${audio.duration.toFixed(2)}s duration`, 'success');
                };

                audio.onplay = () => {
                    log('‚ñ∂ Audio playing...', 'success');
                };

                audio.onended = () => {
                    log('‚úì Audio playback completed!', 'success');
                    URL.revokeObjectURL(audioUrl);
                };

                audio.onerror = (e) => {
                    log(`‚úó Audio playback error: ${audio.error?.message || 'Unknown error'}`, 'error');
                    URL.revokeObjectURL(audioUrl);
                };

                await audio.play();
                log('\n========================================', 'step');
                log('‚úì ALL TESTS PASSED!', 'success');
                log('If you heard speech, the system is working!', 'success');
                log('========================================', 'step');

            } catch (error) {
                log(`\n‚úó ERROR: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }
    </script>
</body>
</html>
