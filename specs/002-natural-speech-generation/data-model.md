# Data Model: Natural Speech Generation

**Feature**: Natural Speech Generation for Shipping Forecast
**Date**: 2026-02-01
**Status**: Complete

## Overview

This document defines the data entities, relationships, and state transitions for SSML-based natural speech generation. The system transforms structured weather report objects into SSML templates, synthesizes audio via Google Cloud TTS, and manages caching for cost optimization.

---

## Entity Definitions

### 1. WeatherReport

**Source**: Generated by `/src/core/generator.js` (already exists)

**Description**: Structured representation of a complete shipping forecast report

**Fields**:
```javascript
{
  // Area information
  area: {
    name: string,           // "Viking", "Dogger", "The Void", etc.
    type: "standard" | "phantom",
    id: string              // Kebab-case: "viking", "the-void"
  },
  
  // Wind conditions
  wind: {
    direction: string,      // "Northerly", "Southwesterly", "Variable"
    behavior: string | null, // "Backing", "Veering", null
    force: number | number[], // Single: 7, Compound: [5, 7]
    connector: string | null, // "or", "to", "occasionally", null (for compound forces)
    modifier: string | null,  // "increasing", "decreasing", null
    timing: string | null     // "later", "at first", null
  },
  
  // Sea conditions
  seaState: string,         // "Slight", "Moderate", "Rough", "Very rough"
  seaTiming: string | null, // "at first", null
  waves: string | null,     // "Moderate swell", "Heavy swell", null
  
  // Weather
  weather: string,          // "Fair", "Rain", "Fog", "Showers"
  weatherTiming: string | null,
  
  // Visibility
  visibility: string,       // "Good", "Moderate", "Poor", "Dense fog"
  visibilityTiming: string | null,
  
  // Additional conditions
  pressure: string | null,  // "Pressure rising", "Pressure falling slowly", null
  
  // Metadata
  timestamp: string,        // ISO 8601 timestamp
  text: string              // Human-readable formatted text (for fallback/logging)
}
```

**Validation Rules**:
- `area.name`: Must match one of 31 standard areas or 7 phantom areas
- `wind.force`: Single value 4-12, or compound array [4-12, 4-12] where `[1] > [0]`
- `wind.connector`: Required if `wind.force` is array, must be "or", "to", or "occasionally"
- `seaState`: Must match vocabulary (8 options)
- `weather`: Must match vocabulary (8 options)
- `visibility`: Must match vocabulary (8 options)
- `timestamp`: Valid ISO 8601 format
- All string fields: Non-empty, trimmed

**Relationships**:
- Generated by: `WeatherReportGenerator` (`/src/core/generator.js`)
- Consumed by: `SSMLTemplateBuilder` (new)
- Used in: `AudioCache` key generation (new)

---

### 2. SSMLTemplate

**Description**: SSML document structure representing a weather report with prosody markup

**Fields**:
```javascript
{
  // SSML content
  ssml: string,             // Complete SSML document (see structure below)
  
  // Metadata
  reportId: string,         // Hash/UUID for tracking
  areaName: string,         // "Viking" (for debugging/logging)
  isPhantom: boolean,       // Determines prosody rules
  characterCount: number,   // For cost tracking
  
  // Generated timestamp
  createdAt: Date
}
```

**SSML Structure**:
```xml
<speak>
  <!-- Phantom areas: wrap entire report in speed/pitch adjustment -->
  <prosody rate="0.9" pitch="-12%">
    
    <!-- Area name with strong emphasis and 800ms pause -->
    <prosody pitch="+0%">
      <emphasis level="strong">Viking.</emphasis>
      <break time="800ms"/>
    </prosody>
    
    <!-- Wind at 85-90% rate with pauses -->
    <prosody rate="0.85">
      Southwesterly<break time="200ms"/>
      5 to 7,<break time="600ms"/>
      increasing later.<break time="600ms"/>
    </prosody>
    
    <!-- Sea state with mid-report pitch drop (phantom only) -->
    <prosody pitch="-12%">
      Rough at first, moderate swell.<break time="600ms"/>
    </prosody>
    
    <!-- Weather -->
    Rain.<break time="600ms"/>
    
    <!-- Visibility with reduced emphasis and end recovery pitch -->
    <prosody pitch="-6%">
      <emphasis level="reduced">Good.</emphasis>
      <break time="600ms"/>
    </prosody>
    
    <!-- Pressure (optional) -->
    Pressure falling slowly.<break time="1500ms"/>
    
  </prosody>
</speak>
```

**Validation Rules**:
- `ssml`: Must be valid XML, must start with `<speak>` and end with `</speak>`
- `characterCount`: Must be positive integer
- `ssml`: Must contain all required `<break>` tags per FR-020 through FR-025

**Relationships**:
- Generated by: `SSMLTemplateBuilder` (new)
- Consumed by: `TTSServiceAdapter.synthesize()` (new)

---

### 3. SynthesisRequest

**Description**: Request payload for Google Cloud Text-to-Speech API

**Fields**:
```javascript
{
  // Input
  input: {
    ssml: string            // From SSMLTemplate.ssml
  },
  
  // Voice configuration
  voice: {
    languageCode: "en-GB",
    name: "en-GB-Neural2-B",
    ssmlGender: "MALE"
  },
  
  // Audio configuration
  audioConfig: {
    audioEncoding: "MP3",
    sampleRateHertz: 24000,
    speakingRate: 1.0,      // Controlled via SSML prosody tags
    pitch: 0.0,             // Controlled via SSML prosody tags
    effectsProfileId: ["headphone-class-device"]
  }
}
```

**API Response**:
```javascript
{
  audioContent: string,     // Base64-encoded MP3 audio
  timepoints: [             // Optional timing information
    {markName: string, timeSeconds: number}
  ],
  audioConfig: {            // Echo of request config
    audioEncoding: "MP3",
    sampleRateHertz: 24000
  }
}
```

**Relationships**:
- Created by: `TTSServiceAdapter.synthesize()` (new)
- Sent to: Google Cloud TTS API (`https://texttospeech.googleapis.com/v1/text:synthesize`)

---

### 4. GeneratedAudio

**Description**: Audio blob with metadata from TTS synthesis

**Fields**:
```javascript
{
  // Audio data
  audioBuffer: AudioBuffer, // Decoded via AudioContext.decodeAudioData()
  audioBlob: Blob,          // Original MP3 blob (for caching)
  base64Audio: string,      // From TTS API response
  
  // Metadata
  reportId: string,         // Links to SSMLTemplate
  areaName: string,
  isPhantom: boolean,
  duration: number,         // Seconds (from audioBuffer.duration)
  sampleRate: number,       // 24000 (from audioBuffer.sampleRate)
  fileSize: number,         // Bytes (audioBlob.size)
  
  // Timestamps
  synthesizedAt: Date,      // When TTS API call completed
  cachedAt: Date | null     // When added to cache (null if not cached)
}
```

**Validation Rules**:
- `audioBuffer`: Must be valid AudioBuffer with `numberOfChannels >= 1`
- `duration`: Must be between 8-25 seconds (typical report length)
- `fileSize`: Should be ~60-120KB for 15-second report at 48kbps
- `sampleRate`: Must be 24000 (as specified in audioConfig)

**Relationships**:
- Created by: `TTSServiceAdapter.synthesize()` (new)
- Stored in: `AudioCache` (new)
- Consumed by: `SSMLSynthesizer.speakReport()` (new) → `AudioPlayer` (existing)

---

### 5. ProsodyConfig

**Description**: BBC Radio 4 timing and emphasis rules (configuration object, not persisted)

**Structure**:
```javascript
{
  // Speaking rates (FR-014)
  rates: {
    standard: 0.85,         // 85% for standard areas
    phantom: 0.9            // 90% for phantom areas (additional to pitch/speed)
  },
  
  // Pause durations (FR-020 through FR-025)
  breaks: {
    afterAreaName: "800ms",
    afterWindDirection: "200ms",
    afterWindForce: "600ms",
    afterSeaState: "600ms",
    afterWeather: "600ms",
    afterVisibility: "600ms",
    endOfReport: "1500ms"
  },
  
  // Emphasis levels (FR-019, FR-026)
  emphasis: {
    areaName: "strong",
    visibility: "reduced",
    default: "moderate"
  },
  
  // Phantom area effects (FR-027, FR-028)
  phantom: {
    speedMultiplier: 0.9,   // 10% slower
    pitchContour: {
      start: "+0%",         // Area name: normal
      middle: "-12%",       // Wind/sea: maximum drop
      end: "-6%"            // Visibility/pressure: partial recovery
    }
  }
}
```

**Usage**:
- Referenced by: `SSMLTemplateBuilder` to construct proper SSML markup
- Defined in: `/src/audio/prosody-config.js` (new, exported constant)

---

### 6. CacheEntry

**Description**: Cached audio with metadata for LRU eviction

**Fields**:
```javascript
{
  key: string,              // Cache key (composite of report fields)
  audioBlob: Blob,          // Cached MP3 blob
  audioBuffer: AudioBuffer, // Decoded audio (optional, for faster playback)
  
  // Metadata
  reportData: {             // Subset of WeatherReport for reconstruction
    areaName: string,
    wind: object,
    seaState: string,
    weather: string,
    visibility: string
  },
  
  // Cache management
  timestamp: Date,          // Last accessed (for LRU)
  hitCount: number,         // Cache hits for this entry (for metrics)
  fileSize: number          // Bytes (for memory tracking)
}
```

**Cache Key Format**:
```javascript
function generateCacheKey(report) {
  return `${report.area.name}-${JSON.stringify(report.wind)}-${report.seaState}-${report.weather}-${report.visibility}`;
}
```

**Validation Rules**:
- `key`: Must be unique within cache
- `timestamp`: Updated on every access (LRU tracking)
- `fileSize`: Must be positive integer
- Cache size limit: Max 50 entries (per research decision)
- Memory limit: Max 1.5MB total (50 entries × ~30KB average)

**Relationships**:
- Stored in: `AudioCache.cache` (Map object)
- Managed by: `AudioCache` class (new)
- Eviction policy: LRU (Least Recently Used) when cache full

---

## State Transitions

### Report Generation → Audio Playback Flow

```
[1. Generate Report]
  WeatherReportGenerator.generateWeatherReport()
  ↓
  WeatherReport object
  ↓
[2. Check Cache]
  AudioCache.get(cacheKey)
  ↓
  Cache HIT? → GeneratedAudio → [Skip to 6]
  ↓
  Cache MISS → Continue
  ↓
[3. Build SSML]
  SSMLTemplateBuilder.build(WeatherReport)
  ↓
  SSMLTemplate object
  ↓
[4. Synthesize Audio]
  TTSServiceAdapter.synthesize(SSMLTemplate)
  ↓
  API Call → Google Cloud TTS
  ↓
  Success? → SynthesisRequest/Response
  ↓
  Failure? → Throw error → Fallback Handler
  ↓
[5. Decode Audio]
  AudioContext.decodeAudioData(base64MP3)
  ↓
  GeneratedAudio object
  ↓
  AudioCache.set(cacheKey, GeneratedAudio)
  ↓
[6. Play Audio]
  SSMLSynthesizer.speakReport() → AudioPlayer
  ↓
  Web Audio API Playback
  ↓
  Radio Filter Effects (existing)
  ↓
  Audio Output (speakers/headphones)
```

### Error Handling & Fallback Flow

```
[Synthesis Failure Detected]
  TTSServiceAdapter.synthesize() throws error
  ↓
  Increment failureCount
  ↓
  failureCount >= 3?
  ↓
  YES → Enable Fallback Mode
    ↓
    Switch synthesizer:
    SSMLSynthesizer → LibrarySynthesizer (MP3 concatenation)
    ↓
    Log warning to console
    ↓
    Continue playback with MP3 library
    ↓
    Remain in fallback mode for session
  ↓
  NO → Retry next report
    ↓
    Return to normal synthesis flow
```

### Cache Eviction Flow

```
[AudioCache.set() called]
  ↓
  Cache size >= maxSize (50)?
  ↓
  YES → Find LRU entry
    ↓
    Sort entries by timestamp (oldest first)
    ↓
    Delete oldest entry
    ↓
    Free memory
  ↓
  NO → Skip eviction
  ↓
  Add new entry to cache
  ↓
  Update metrics (hitCount, memory usage)
```

---

## Relationships Diagram

```
┌─────────────────────┐
│ WeatherReport       │
│ (from generator.js) │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ SSMLTemplateBuilder │
│ .build()            │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ SSMLTemplate        │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐        ┌─────────────────────┐
│ TTSServiceAdapter   │───────→│ Google Cloud TTS    │
│ .synthesize()       │        │ API                 │
└──────────┬──────────┘        └─────────────────────┘
           │
           ↓
┌─────────────────────┐
│ SynthesisRequest/   │
│ Response            │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ GeneratedAudio      │
└──────────┬──────────┘
           │
           ├─────────────────────┐
           │                     ↓
           │              ┌─────────────────────┐
           │              │ AudioCache          │
           │              │ (Map: key → entry)  │
           │              └─────────────────────┘
           │
           ↓
┌─────────────────────┐
│ SSMLSynthesizer     │
│ .speakReport()      │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ AudioPlayer         │
│ (existing)          │
└─────────────────────┘
```

---

## Data Persistence

**No Traditional Persistence** - This is a browser-based application with no backend database

**Memory Storage**:
- **AudioCache**: In-memory Map object (cleared on page reload)
- **Lifetime**: Single session (hours, not days)
- **Size**: ~1.5MB maximum (50 entries × 30KB average)

**Future Considerations** (Not in current scope):
- **IndexedDB**: Could persist cache across sessions if needed
- **LocalStorage**: Could store API key, user preferences (not weather data)
- **Service Worker**: Could cache audio for offline playback

---

## Validation & Constraints Summary

### WeatherReport
- ✅ Area name must exist in vocabulary (31 standard + 7 phantom)
- ✅ Wind force: 4-12 (single) or [4-12, 4-12] (compound)
- ✅ Compound force requires connector ("or", "to", "occasionally")
- ✅ All vocabulary fields must match defined options

### SSMLTemplate
- ✅ Valid XML structure
- ✅ Must contain `<speak>` root element
- ✅ All required `<break>` tags present (800ms, 200ms, 600ms, 1500ms)
- ✅ Character count > 0

### GeneratedAudio
- ✅ Duration: 8-25 seconds (typical report range)
- ✅ Sample rate: 24000 Hz
- ✅ File size: ~60-120KB (reasonable for 48kbps MP3)
- ✅ AudioBuffer must be valid (channels >= 1)

### AudioCache
- ✅ Max 50 entries (LRU eviction)
- ✅ Max 1.5MB total memory
- ✅ Unique keys (no duplicates)
- ✅ Timestamps updated on access

---

## Performance Characteristics

| Operation | Latency | Memory | Notes |
|-----------|---------|--------|-------|
| Generate WeatherReport | <1ms | ~1KB | Existing generator.js performance |
| Build SSMLTemplate | ~2-5ms | ~2KB | String concatenation, XML construction |
| TTS API synthesis | 800-1500ms | 0 (network) | Network latency + Google processing |
| Decode MP3 to AudioBuffer | 50-150ms | ~500KB | Browser decoding, depends on duration |
| Cache lookup | <1ms | 0 | Map.get() is O(1) |
| Cache insertion | <1ms | ~30KB | Map.set() is O(1), LRU eviction if needed |
| Total (cache miss) | ~1000-1700ms | ~530KB | Meets FR-003 (<2s requirement) |
| Total (cache hit) | <200ms | ~500KB | Instant playback |

**Memory Profile** (steady state):
- Active audio playback: ~500KB (1 AudioBuffer)
- Audio cache (50 entries): ~1.5MB
- JavaScript objects: ~100KB
- **Total**: ~2.1MB (negligible for modern browsers)

---

## Next Steps

With data model complete, proceed to:
1. **API Contracts**: Define interfaces for TTSServiceAdapter, SSMLTemplateBuilder, AudioCache
2. **Quickstart Guide**: Document setup, testing, and integration for developers
3. **Task Breakdown**: Generate implementation tasks via `/speckit.tasks`
