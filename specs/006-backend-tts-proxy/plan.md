# Implementation Plan: Backend TTS API Proxy

**Branch**: `006-backend-tts-proxy` | **Date**: 2026-02-04 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-backend-tts-proxy/spec.md`

## Summary

Implement a secure backend proxy service that intermediates all TTS API requests between the frontend and Google Cloud TTS API. The proxy will hold API credentials server-side, implement rate limiting (30 req/min per IP), validate request origins, and return synthesized audio to the frontend. This addresses the critical security vulnerability of exposing the API key in client-side code, which could lead to unlimited financial costs if exploited.

**Technical Approach**: Cloudflare Workers for serverless proxy with Workers KV for rate limiting state, environment secrets for API key storage, and custom CORS/origin validation middleware.

## Technical Context

**Language/Version**: JavaScript ES6+ (Cloudflare Workers runtime, V8)
**Primary Dependencies**:
- Cloudflare Workers (serverless runtime)
- Wrangler CLI (deployment tool)
- Workers KV (rate limiting state storage)
- Google Cloud Text-to-Speech API v1 (existing)

**Storage**: Workers KV (distributed key-value store for rate limit counters)
**Testing**:
- Automated security tests (REQUIRED by Constitution II exception)
- Manual testing via test HTML pages
- Browser DevTools network inspection

**Target Platform**: Cloudflare Workers (edge compute, 275+ global locations)
**Project Type**: Web application (existing frontend + new backend proxy)
**Performance Goals**:
- Proxy latency overhead < 200ms (target: < 50ms with edge)
- Rate limit validation < 100ms
- Support 100 concurrent requests

**Constraints**:
- Zero API key exposure (P1 requirement)
- 30 requests/minute per IP rate limit
- Must work with existing TTS service adapter
- Free tier usage (100k req/day limit)

**Scale/Scope**: Personal project, ~1000 TTS requests/month estimated

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Personal Project Workflow ✅ PASS
- Single developer project with rapid iteration focus
- Cloudflare Workers chosen for simplicity and low maintenance
- No complex infrastructure or team coordination needed

### Principle II: No Automated Testing Required ⚠️ EXCEPTION APPLIES
- **Constitution Exception**: This feature falls under the security testing exception
- **MUST HAVE** automated tests for:
  1. API key obfuscation verification (zero credential exposure)
  2. Rate limiting enforcement (30 req/min per IP)
  3. Origin validation (unauthorized domain rejection)
- **Rationale**: Security vulnerabilities could lead to financial loss; manual testing insufficient for verifying credential exposure
- **Test Approach**: Automated security tests + manual browser testing for UX

### Principle III: Natural Speech Quality ✅ PASS
- Proxy is transparent to audio quality
- Returns identical audio data from Google Cloud TTS
- No processing or modification of synthesized audio

### Principle IV: Real-Time Generation ✅ PASS
- Proxy maintains real-time TTS synthesis flow
- Adds < 50ms latency (edge routing)
- No change to existing SSML generation logic

**Constitution Compliance**: ✅ APPROVED with security testing exception

## Project Structure

### Documentation (this feature)

```text
specs/006-backend-tts-proxy/
├── plan.md              # This file
├── research.md          # Platform comparison and rate limiting strategies
├── data-model.md        # Request/response entities and rate limit state
├── quickstart.md        # Local development and deployment guide
├── contracts/           # API contract specifications
│   ├── proxy-api.yaml   # OpenAPI spec for proxy endpoint
│   └── tts-request.schema.json  # JSON schema for TTS request payload
└── tasks.md             # Generated by /speckit.tasks (not yet created)
```

### Source Code (repository root)

```text
backend/                 # NEW: Backend proxy service
├── src/
│   ├── index.js        # Main Worker entry point
│   ├── rate-limiter.js # IP-based rate limiting logic
│   ├── origin-validator.js  # CORS and origin validation
│   ├── tts-proxy.js    # Google Cloud TTS API proxy logic
│   └── error-handler.js     # Error response formatting
├── tests/
│   └── security/       # REQUIRED: Security tests per Constitution
│       ├── api-key-exposure.test.js
│       ├── rate-limiting.test.js
│       └── origin-validation.test.js
├── wrangler.toml       # Cloudflare Workers configuration
└── package.json        # Dependencies and scripts

frontend/                # EXISTING: Frontend application
└── src/
    └── audio/
        └── tts-service-adapter.js  # MODIFIED: Update to use proxy endpoint
```

**Structure Decision**: Added `backend/` directory for the new Cloudflare Worker proxy service. Frontend remains in existing `src/` structure with minor modifications to the TTS adapter to call the proxy instead of Google Cloud TTS directly.

## Complexity Tracking

> No constitution violations requiring justification. Security testing exception is explicitly covered by Constitution v1.1.0, Principle II.

## Phase 0: Research

[See research.md](research.md) for detailed analysis.

**Key Decisions**:

1. **Platform Choice**: Cloudflare Workers
   - **Rationale**: 0-10ms latency overhead, generous free tier (100k req/day), global edge network, Workers KV for distributed rate limiting
   - **Alternatives**: Vercel Edge Functions (good), Netlify Functions (acceptable), AWS Lambda (too complex)

2. **Rate Limiting Strategy**: Workers KV with sliding window
   - **Implementation**: Store per-IP counters in KV with 60-second TTL
   - **Key format**: `ratelimit:{ip}:{minute}`
   - **Threshold**: 30 requests per 60-second window

3. **Origin Validation**: Allowed origins list in environment config
   - **Environments**: localhost:*, GitHub Pages domain, custom domain (if applicable)
   - **Method**: Validate Origin or Referer header against allow list

4. **API Key Storage**: Cloudflare Worker Secrets
   - **Access**: Via `env.GOOGLE_TTS_API_KEY` binding at runtime
   - **Security**: Encrypted, never logged, not accessible via API

## Phase 1: Design & Contracts

### Data Model

[See data-model.md](data-model.md) for complete entity definitions.

**Core Entities**:

1. **TTSRequest** (incoming from frontend)
   - ssml: string (SSML content)
   - voice: object (languageCode, name)
   - audioConfig: object (encoding, sampleRate)

2. **TTSResponse** (outgoing to frontend)
   - audioContent: string (base64 audio) | null
   - error: object (message, code) | null
   -
3. **RateLimitState** (Workers KV)
   - key: `ratelimit:{ip}:{minute}`
   - value: number (request count)
   - ttl: 60 seconds

4. **ProxyConfig** (environment)
   - GOOGLE_TTS_API_KEY: secret
   - ALLOWED_ORIGINS: comma-separated string
   - RATE_LIMIT_THRESHOLD: number (default: 30)

### API Contracts

[See contracts/proxy-api.yaml](contracts/proxy-api.yaml) for OpenAPI specification.

**Endpoint**: `POST /synthesize`

**Request Headers**:
- `Content-Type: application/json`
- `Origin: https://yourdomain.com` (validated)

**Request Body**:
```json
{
  "input": {
    "ssml": "<speak>...</speak>"
  },
  "voice": {
    "languageCode": "en-GB",
    "name": "en-GB-Neural2-D"
  },
  "audioConfig": {
    "audioEncoding": "MP3",
    "sampleRateHertz": 24000
  }
}
```

**Success Response (200)**:
```json
{
  "audioContent": "base64_encoded_audio_data",
  "timepoints": [],
  "audioConfig": {...}
}
```

**Error Responses**:
- `429 Rate Limited`: Exceeded 30 req/min
- `403 Forbidden`: Invalid origin
- `400 Bad Request`: Invalid SSML
- `500 Internal Error`: TTS API failure

### Quickstart Guide

[See quickstart.md](quickstart.md) for full local development instructions.

**Quick Start**:
1. Install Wrangler: `npm install -g wrangler`
2. Navigate to backend: `cd backend`
3. Set up KV namespace: `wrangler kv:namespace create RATE_LIMIT_KV`
4. Configure secrets: `wrangler secret put GOOGLE_TTS_API_KEY`
5. Run locally: `wrangler dev`
6. Deploy: `wrangler deploy`
7. Update frontend with proxy URL

## Phase 2: Task Breakdown

Phase 2 (task generation) is handled by the `/speckit.tasks` command and will create `tasks.md` with:
- Backend proxy implementation tasks
- Frontend adapter modification tasks
- Security testing tasks (per Constitution exception)
- Deployment and configuration tasks

**Not included in this plan document**. Run `/speckit.tasks` to generate.

## Notes

- **Security First**: This feature is critical security infrastructure. All three automated tests (API key exposure, rate limiting, origin validation) are REQUIRED by Constitution v1.1.0, Principle II exception.
- **Existing Frontend**: The frontend TTS adapter in `src/audio/tts-service-adapter.js` already exists and needs modification to call the proxy instead of Google Cloud TTS directly.
- **No Audio Files**: This feature does NOT affect the existing pre-generated audio library in `public/audio/`. The proxy only handles real-time TTS synthesis requests.
- **Free Tier**: Cloudflare Workers free tier (100k req/day) far exceeds project needs (~33 req/day estimated).
- **Latency Target**: With Cloudflare edge routing, proxy overhead should be 10-50ms, well under the 200ms requirement.
